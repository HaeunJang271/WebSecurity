"""
Vulnerability schemas for request/response validation
"""
from datetime import datetime
from typing import Optional, List, Dict, Any, Union
from pydantic import BaseModel, field_validator

from app.models.vulnerability import Severity


class VulnerabilityResponse(BaseModel):
    """Schema for vulnerability response"""
    id: int
    scan_id: int
    vuln_type: str
    name: str
    severity: str  # String으로 변경 (Enum 호환성)
    cvss_score: Optional[int] = None
    
    affected_url: str
    affected_parameter: Optional[str] = None
    http_method: str = "GET"
    
    description: str
    evidence: Optional[str] = None
    recommendation: Optional[str] = None
    references: Optional[Any] = None  # JSON 호환성
    cwe_id: Optional[str] = None
    
    is_false_positive: int = 0
    detected_at: datetime
    
    @field_validator('severity', mode='before')
    @classmethod
    def convert_severity(cls, v):
        """Enum을 문자열로 변환"""
        if hasattr(v, 'value'):
            return v.value
        return str(v)
    
    model_config = {"from_attributes": True}


class VulnerabilityListResponse(BaseModel):
    """Schema for list of vulnerabilities"""
    vulnerabilities: List[VulnerabilityResponse]
    total: int
    
    # Summary by severity
    critical: int = 0
    high: int = 0
    medium: int = 0
    low: int = 0
    info: int = 0


class VulnerabilitySummary(BaseModel):
    """Schema for vulnerability summary"""
    total: int
    by_severity: Dict[str, int]
    by_type: Dict[str, int]
    top_affected_urls: List[str]

