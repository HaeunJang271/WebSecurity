"""
Vulnerability model for storing detected vulnerabilities
"""
from datetime import datetime
from enum import Enum
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text, Enum as SQLEnum, JSON

from app.core.database import Base
from sqlalchemy.orm import relationship


class Severity(str, Enum):
    """Vulnerability severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class Vulnerability(Base):
    """Vulnerability model for storing detected security issues"""
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=False)
    
    # Vulnerability identification
    vuln_type = Column(String(100), nullable=False)  # sqli, xss, csrf, etc.
    name = Column(String(255), nullable=False)
    
    # Severity
    severity = Column(SQLEnum(Severity), nullable=False)
    cvss_score = Column(Integer, nullable=True)  # 0-10
    
    # Location
    affected_url = Column(String(2048), nullable=False)
    affected_parameter = Column(String(255), nullable=True)
    http_method = Column(String(10), default="GET")
    
    # Details
    description = Column(Text, nullable=False)
    evidence = Column(Text, nullable=True)
    request_data = Column(JSON, nullable=True)
    response_data = Column(JSON, nullable=True)
    
    # Remediation
    recommendation = Column(Text, nullable=True)
    references = Column(JSON, nullable=True)  # List of URLs
    cwe_id = Column(String(20), nullable=True)  # CWE-79, CWE-89, etc.
    
    # Status
    is_false_positive = Column(Integer, default=0)  # 0 = not reviewed, 1 = false positive
    
    # Timestamps
    detected_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    scan = relationship("Scan", back_populates="vulnerabilities")
    
    def __repr__(self):
        return f"<Vulnerability(id={self.id}, type={self.vuln_type}, severity={self.severity})>"

